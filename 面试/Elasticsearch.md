### ES和MySQL

- MySQL是一种关系型数据库，它使用表格结构来组织数据，适用于结构化数据存储和复杂的数据关系模型。它通常用于事务处理和数据持久化。
- Elasticsearch是专为快速全文搜索和分析而设计的，它使用JSON文档来存储数据，支持全文搜索、聚合等功能。它更适合于非结构化或半结构化数据的搜索和分析。它使用倒排索引等技术，能够在大规模数据集上进行高效的文本搜索，适合于实时搜索和大规模日志数据分析。
- MySQL的文本搜索不如Elasticsearch高效。MySQL更适合于关系型数据的事务处理和较为简单的查询。

### 基本概念

**Index（索引）**：索引是一类拥有相似特征的文档的集合，比如商品索引，商家索引，有点类似于MySQL数据库中的数据表。

**Document（文档）**：可搜索的最小单位，用于存储数据，一般为JSON格式，文档由一个或者多个字段构成。

**Mapping（映射）**：定义字段名称，数据类型，优化信息（比如是否索引），分词器，有点类似于数据库中的表结构定义，一个Index对应一个Mapping。

**Shard（分片）**：Index（索引）被分为多个碎片存储在不同的Node节点上的分片中，以提高性能和吞吐量。

**Replica（副本）**：Index（副本），每个Index有一个或者多个副本，以提高拓展功能和吞吐量。

### 倒排索引

倒排索引是一种用于提高数据库检索速度的一种数据结构，空间消耗比较大。倒排索引首先将索引文档进行分词得到多个词条，然后将词语和文档ID建立关联，从而提高检索效率。

正排索引：

优点：维护成本低，新增数据的时候，只要在末尾新增一个ID

缺点：查询时需要扫描所有的词语，一个一个比较，直至查到关键词，查询效率低。

倒排索引：

优点：建立分词和ID的关系，提高查询效率。

缺点：建立倒排索引的成本高。并且，维护起来也比较麻烦，因为文档的每次更新都意味着倒排索引的重建。

倒排索引的创建流程：

1.建立文档列表，每个文档都有唯一的一个ID与之对应。

2.通过分词器对文档进行分词，生成  `<词语，文档ID>`  的组数据。

3.将词语作为索引关键字，记录下词语和文档对应的关系。
### 数据同步

可以将同步类型分为全量同步和增量同步。

- 全量同步即建好Elasticsearch 引后一次性导入 MySQL所有数据。全量同步有很多现成的工具可以用比如Datax.

- 增量同步即对MySQL中新增，更新的数据进行同步:
	- 使用消息队列：将MySQL中的数据变更以消息的形式发送到消息队列，然后由消费者从消息队列中读取消息，并将数据同步到Elasticsearch中。
	- 使用定时任务：编写定时任务或调度程序，在固定的时间间隔内从MySQL中读取数据的变更，并批量同步到Elasticsearch中。这种方式可能会有一定的延迟，适用于一些对数据同步实时性要求不高的场景。
	- Canal(推荐)：
		1. **实时数据监控并同步数据**：Canal可以实时监控数据库的数据变更（通过监控binlog），保证目标系统中的数据与源数据库保持同步，确保数据的实时性和准确性。
		2. **数据同步**：Canal可以将捕获到的数据变更事件同步到其他系统，如Elasticsearch、Hadoop、Kafka等。
		4. **数据订阅**：Canal支持按照数据库、表、列等维度进行数据订阅，用户可以选择订阅感兴趣的数据，减少不必要的数据传输和处理。
		5. **解耦数据处理**：Canal将数据变更事件转发到其他系统，可以实现数据的解耦。源数据库和目标系统之间可以独立运作，不会相互影响。

### 集群

在Elasticsearch（ES）集群中，数据被分配到多个分片（Shard）中。ES使用分片来实现数据的水平分布和并行处理，从而提高搜索和查询的性能和可伸缩性。数据分片是ES集群中数据分布和存储的基本单位。

ES中的数据分片有两种类型：主分片（Primary Shard）和副本分片（Replica Shard）。

1. **主分片**：
    
    - 每个索引都可以划分为多个主分片，每个主分片都是一个独立的Lucene索引，负责存储部分数据。
    - 主分片的数量在索引创建时定义，并且在后续无法修改。索引创建时，必须指定主分片的数量，一旦索引创建完成，主分片数量就不可更改。
2. **副本分片**：
    
    - 副本分片是主分片的复制，用于提供数据冗余和高可用性。副本分片中存储与其对应的主分片相同的数据。
    - 副本分片的数量可以在索引创建后动态调整。可以根据需要增加或减少副本分片的数量，以提高系统的容错性和性能。

数据分配的过程如下：

1. 当创建索引时，Elasticsearch根据索引的主分片数量在集群中的节点间均匀分配主分片。每个主分片在不同节点上创建，并分布在不同的节点上，以实现数据的分布式存储和并行处理。
2. 一旦主分片被分配到节点上，ES会自动为每个主分片分配相应数量的副本分片。副本分片将在其他节点上进行复制，以实现数据冗余和高可用性。

自定义路由的好处： 自定义路由是指在创建索引时，手动指定文档应该被分配到哪个主分片上。默认情况下，Elasticsearch会根据文档的ID来选择主分片，这种分配方式在大多数情况下已经足够有效。但在某些情况下，自定义路由可以带来以下好处：

1. **均衡负载**：通过自定义路由，可以将文档均匀地分配到不同的主分片上，实现更好的负载均衡。这有助于避免某些主分片成为热点，从而提高整个集群的性能。
    
2. **数据本地性**：自定义路由可以确保相关的数据存储在相邻的分片上。这有助于减少分片间的数据传输和网络开销，提高查询性能。
    
3. **集群维护**：在进行集群维护或扩容时，通过自定义路由可以更灵活地管理数据的迁移和重新分配，从而减少数据迁移的成本和影响。

请注意，自定义路由需要谨慎使用，并且需要了解数据和查询模式的特点。错误的自定义路由可能导致数据不均衡或查询性能下降。通常情况下，Elasticsearch的默认分片分配机制已经能够很好地处理大部分情况，除非有特定需求，否则建议不要轻易修改默认的分片分配策略。